services:
  mysql:
    image: mysql:8.0
    container_name: todo-mysql
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    ports:
      - "${DB_PORT}:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10
      interval: 5s
    networks:
      - todo-network
    restart: unless-stopped

  redis:
    image: redis/redis-stack:latest
    container_name: todo-redis
    ports:
      - "${REDIS_PORT}:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      timeout: 3s
      retries: 5
      interval: 5s
    networks:
      - todo-network
    restart: unless-stopped

  # localstack:
  #   image: localstack/localstack:latest
  #   container_name: todo-localstack
  #   ports:
  #     - "4566:4566"
  #   environment:
  #     SERVICES: s3
  #     DEBUG: 1
  #     DOCKER_HOST: unix:///var/run/docker.sock
  #     AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
  #     AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
  #     AWS_DEFAULT_REGION: ${AWS_DEFAULT_REGION}
  #   volumes:
  #     - ./localstack-init.sh:/etc/localstack/init/ready.d/init.sh:ro
  #     - "/var/run/docker.sock:/var/run/docker.sock"
  #   networks:
  #     - todo-network
  #   restart: unless-stopped

  localstack:
    image: localstack/localstack:latest
    ports:
      - "4566:4566"
    environment:
      - SERVICES=s3
      - DEBUG=1
      - S3_BUCKET=${S3_BUCKET}
    volumes:
      - ./localstack-init.sh:/etc/localstack/init/ready.d/init.sh:ro
    networks:
      - todo-network

  

  # Go Web Application
  # app:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile
  #   container_name: todo-app
  #   ports:
  #     - "${APP_PORT}:${APP_PORT}"
  #   environment:
  #     APP_PORT: ${APP_PORT}
  #     DB_HOST: ${DB_HOST}
  #     DB_PORT: ${DB_PORT}
  #     DB_USER: ${DB_USER}
  #     DB_PASSWORD: ${DB_PASSWORD}
  #     DB_NAME: ${DB_NAME}
  #     REDIS_HOST: ${REDIS_HOST}
  #     REDIS_PORT: ${REDIS_PORT}
  #     REDIS_ADDR: ${REDIS_ADDR}
  #     REDIS_STREAM: ${REDIS_STREAM}
  #     S3_ENDPOINT: ${S3_ENDPOINT}
  #     S3_BUCKET: ${S3_BUCKET}
  #     AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
  #     AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
  #     AWS_DEFAULT_REGION: ${AWS_DEFAULT_REGION}
  #   depends_on:
  #     mysql:
  #       condition: service_healthy
  #     redis:
  #       condition: service_healthy
  #     localstack:
  #       condition: service_started
  #   networks:
  #     - todo-network
  #   restart: unless-stopped
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
  #     timeout: 10s
  #     retries: 5
  #     interval: 10s


volumes:
  mysql_data:

networks:
  todo-network:
    driver: bridge